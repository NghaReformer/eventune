---
/**
 * Dashboard Layout
 * Luxurious sidebar navigation with music studio aesthetic
 *
 * Security: Uses server-side session validation
 */
import { getFirstName, setCSRFToken, type SessionData } from '../lib/auth/session';

interface Props {
  title: string;
  activeNav?: 'dashboard' | 'orders' | 'profile' | 'referrals';
}

const { title, activeNav = 'dashboard' } = Astro.props;

// Session is set by middleware - if we reach here, user is authenticated
const session = Astro.locals.session as SessionData;

// Fallback redirect (shouldn't happen if middleware is working)
if (!session) {
  const currentPath = Astro.url.pathname;
  return Astro.redirect(`/auth/login?redirectTo=${encodeURIComponent(currentPath)}`);
}

const { user, profile } = session;
const firstName = getFirstName(profile);

// Set CSRF token for forms
const csrfToken = setCSRFToken(Astro.cookies);
Astro.locals.csrfToken = csrfToken;

const navItems = [
  {
    href: '/dashboard',
    label: 'Dashboard',
    icon: 'dashboard',
    active: activeNav === 'dashboard'
  },
  {
    href: '/dashboard/orders',
    label: 'My Orders',
    icon: 'orders',
    active: activeNav === 'orders'
  },
  {
    href: '/dashboard/profile',
    label: 'Profile',
    icon: 'profile',
    active: activeNav === 'profile'
  },
  {
    href: '/dashboard/referrals',
    label: 'Referrals',
    icon: 'referrals',
    active: activeNav === 'referrals'
  },
];

// Check if user has admin access
const isAdmin = !!profile?.admin_role;
---

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title} | Eventune Studios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
</head>
<body class="dashboard-body">
  <!-- Mobile Header -->
  <header class="mobile-header">
    <div class="mobile-header-inner">
      <a href="/" class="mobile-logo">
        <div class="logo-icon">
          <span>E</span>
        </div>
        <span class="logo-text">Eventune</span>
      </a>
      <button
        id="mobile-menu-btn"
        class="mobile-menu-btn"
        aria-label="Toggle menu"
      >
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </header>

  <!-- Mobile Sidebar Overlay -->
  <div id="mobile-overlay" class="mobile-overlay"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <!-- Logo -->
    <div class="sidebar-logo">
      <a href="/" class="logo-link">
        <div class="logo-icon-lg">
          <span>E</span>
        </div>
        <div class="logo-text-wrap">
          <span class="logo-brand">Eventune</span>
          <span class="logo-sub">Studios</span>
        </div>
      </a>
    </div>

    <!-- User Greeting -->
    <div class="user-greeting">
      <div class="user-greeting-inner">
        <div class="user-avatar">
          <span>{firstName.charAt(0).toUpperCase()}</span>
        </div>
        <div class="user-info">
          <p class="user-welcome">Welcome back,</p>
          <p class="user-name">{firstName}</p>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="sidebar-nav">
      <ul class="nav-list">
        {navItems.map((item) => (
          <li>
            <a
              href={item.href}
              class={`nav-item ${item.active ? 'active' : ''}`}
            >
              {item.icon === 'dashboard' && (
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
              )}
              {item.icon === 'orders' && (
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>
              )}
              {item.icon === 'profile' && (
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              )}
              {item.icon === 'referrals' && (
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              )}
              <span class="nav-label">{item.label}</span>
              {item.active && (
                <div class="nav-indicator"></div>
              )}
            </a>
          </li>
        ))}
      </ul>

      {isAdmin && (
        <>
          <!-- Admin Divider -->
          <div class="nav-divider"></div>

          <!-- Admin Portal Link -->
          <a href="/admin" class="admin-link">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>Admin Portal</span>
            <svg class="admin-arrow" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        </>
      )}

      <!-- Divider -->
      <div class="nav-divider"></div>

      <!-- Logout -->
      <a href="/auth/logout" class="logout-link">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        <span>Sign Out</span>
      </a>
    </nav>

    <!-- Studio VU Meter Decoration -->
    <div class="vu-meter-container">
      <div class="vu-meter">
        {[...Array(12)].map((_, i) => (
          <div
            class="vu-bar"
            style={`height: ${20 + Math.random() * 60}%; animation-delay: ${i * 0.1}s;`}
          ></div>
        ))}
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="main-inner">
      <!-- Page Header -->
      <header class="page-header">
        <h1 class="page-title">{title}</h1>
      </header>

      <!-- Page Content -->
      <div class="page-content">
        <slot />
      </div>
    </div>
  </main>

  <style>
    :root {
      --studio-black: #0A0A0A;
      --studio-card: #141414;
      --studio-cream: #F5F5F5;
      --gold: #D4AF37;
      --gold-dark: #B8962E;
    }

    * {
      box-sizing: border-box;
    }

    .dashboard-body {
      background-color: var(--studio-black);
      color: var(--studio-cream);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      padding: 0;
    }

    /* Mobile Header */
    .mobile-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(212, 175, 55, 0.1);
    }

    @media (min-width: 1024px) {
      .mobile-header {
        display: none;
      }
    }

    .mobile-header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      height: 3.5rem;
    }

    .mobile-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .logo-icon {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon span {
      color: var(--studio-black);
      font-weight: 700;
      font-size: 0.875rem;
    }

    .logo-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.125rem;
      color: var(--gold);
    }

    .mobile-menu-btn {
      padding: 0.5rem;
      background: none;
      border: none;
      color: rgba(245, 245, 245, 0.7);
      cursor: pointer;
      transition: color 0.2s;
    }

    .mobile-menu-btn:hover {
      color: var(--gold);
    }

    /* Mobile Overlay */
    .mobile-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .mobile-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    @media (min-width: 1024px) {
      .mobile-overlay {
        display: none;
      }
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 16rem;
      background: var(--studio-card);
      border-right: 1px solid rgba(212, 175, 55, 0.1);
      z-index: 50;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    @media (min-width: 1024px) {
      .sidebar {
        transform: translateX(0);
      }
    }

    /* Sidebar Logo */
    .sidebar-logo {
      height: 4.5rem;
      display: flex;
      align-items: center;
      padding: 0 1.25rem;
      border-bottom: 1px solid rgba(212, 175, 55, 0.1);
    }

    .logo-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
    }

    .logo-icon-lg {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
      transition: box-shadow 0.2s;
    }

    .logo-link:hover .logo-icon-lg {
      box-shadow: 0 4px 16px rgba(212, 175, 55, 0.4);
    }

    .logo-icon-lg span {
      color: var(--studio-black);
      font-weight: 700;
      font-size: 1rem;
    }

    .logo-text-wrap {
      display: flex;
      flex-direction: column;
    }

    .logo-brand {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      color: var(--gold);
      line-height: 1.2;
    }

    .logo-sub {
      font-size: 0.625rem;
      color: rgba(245, 245, 245, 0.5);
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }

    /* User Greeting */
    .user-greeting {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid rgba(212, 175, 55, 0.05);
    }

    .user-greeting-inner {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-avatar {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.05) 100%);
      border: 1px solid rgba(212, 175, 55, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .user-avatar span {
      color: var(--gold);
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      font-weight: 600;
    }

    .user-info {
      min-width: 0;
    }

    .user-welcome {
      font-size: 0.75rem;
      color: rgba(245, 245, 245, 0.5);
      margin: 0;
    }

    .user-name {
      font-family: 'Playfair Display', serif;
      font-size: 1rem;
      color: var(--studio-cream);
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Navigation */
    .sidebar-nav {
      flex: 1;
      padding: 1.25rem 0.75rem;
      overflow-y: auto;
    }

    .nav-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      text-decoration: none;
      color: rgba(245, 245, 245, 0.6);
      transition: all 0.2s ease;
      border-left: 2px solid transparent;
    }

    .nav-item:hover {
      background: rgba(212, 175, 55, 0.05);
      color: var(--studio-cream);
    }

    .nav-item.active {
      background: rgba(212, 175, 55, 0.1);
      color: var(--gold);
      border-left-color: var(--gold);
    }

    .nav-label {
      font-weight: 500;
      font-size: 0.875rem;
    }

    .nav-indicator {
      margin-left: auto;
      width: 0.375rem;
      height: 0.375rem;
      border-radius: 50%;
      background: var(--gold);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .nav-divider {
      margin: 1.25rem 1rem;
      border-top: 1px solid rgba(212, 175, 55, 0.1);
    }

    .admin-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      margin: 0 0.25rem;
      border-radius: 0.5rem;
      text-decoration: none;
      color: var(--gold);
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.2);
    }

    .admin-link:hover {
      background: rgba(212, 175, 55, 0.2);
      border-color: rgba(212, 175, 55, 0.4);
    }

    .admin-arrow {
      margin-left: auto;
      opacity: 0.6;
    }

    .admin-link:hover .admin-arrow {
      opacity: 1;
    }

    .logout-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      margin: 0 0.25rem;
      border-radius: 0.5rem;
      text-decoration: none;
      color: rgba(245, 245, 245, 0.4);
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .logout-link:hover {
      color: #f87171;
      background: rgba(248, 113, 113, 0.1);
    }

    /* VU Meter */
    .vu-meter-container {
      position: absolute;
      bottom: 1.5rem;
      left: 1.5rem;
      right: 1.5rem;
    }

    .vu-meter {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 0.25rem;
      height: 2rem;
      opacity: 0.3;
    }

    .vu-bar {
      width: 0.375rem;
      background: linear-gradient(to top, rgba(212, 175, 55, 0.5) 0%, var(--gold) 100%);
      border-radius: 2px;
      animation: vu-meter 1.5s ease-in-out infinite;
      transform-origin: bottom;
    }

    @keyframes vu-meter {
      0%, 100% { transform: scaleY(0.3); }
      50% { transform: scaleY(1); }
    }

    /* Main Content */
    .main-content {
      min-height: 100vh;
      padding-left: 0;
    }

    @media (min-width: 1024px) {
      .main-content {
        padding-left: 16rem;
      }
    }

    .main-inner {
      padding-top: 3.5rem;
    }

    @media (min-width: 1024px) {
      .main-inner {
        padding-top: 0;
      }
    }

    /* Page Header */
    .page-header {
      padding: 1.5rem 1.25rem;
      border-bottom: 1px solid rgba(212, 175, 55, 0.1);
      background: linear-gradient(90deg, rgba(20, 20, 20, 0.5) 0%, transparent 100%);
    }

    @media (min-width: 640px) {
      .page-header {
        padding: 2rem 1.5rem;
      }
    }

    @media (min-width: 1024px) {
      .page-header {
        padding: 2rem 2.5rem;
      }
    }

    .page-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--studio-cream);
      margin: 0;
    }

    @media (min-width: 640px) {
      .page-title {
        font-size: 1.75rem;
      }
    }

    @media (min-width: 1024px) {
      .page-title {
        font-size: 2rem;
      }
    }

    /* Page Content */
    .page-content {
      padding: 1.25rem;
    }

    @media (min-width: 640px) {
      .page-content {
        padding: 1.5rem;
      }
    }

    @media (min-width: 1024px) {
      .page-content {
        padding: 2.5rem;
      }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--studio-black);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gold);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gold-dark);
    }
  </style>

  <script>
    // Mobile menu toggle
    const menuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');

    function toggleMenu() {
      const isOpen = sidebar?.classList.contains('open');

      if (isOpen) {
        sidebar?.classList.remove('open');
        overlay?.classList.remove('active');
      } else {
        sidebar?.classList.add('open');
        overlay?.classList.add('active');
      }
    }

    menuBtn?.addEventListener('click', toggleMenu);
    overlay?.addEventListener('click', toggleMenu);
  </script>
</body>
</html>
