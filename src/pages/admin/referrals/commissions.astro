---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import Button from '../../../components/ui/Button.astro';
import { supabase } from '../../../lib/supabase/client';

// Fetch commissions
const { data: commissions } = await supabase
  .from('commissions')
  .select('*')
  .order('created_at', { ascending: false });

// Fetch referrers manually
const referrerIds = commissions?.map(c => c.referrer_id) || [];
const { data: referrers } = await supabase
  .from('referral_profiles')
  .select('id, referral_code')
  .in('id', referrerIds);

const commissionsWithData = commissions?.map(c => ({
  ...c,
  referrer_code: referrers?.find(r => r.id === c.referrer_id)?.referral_code || 'Unknown'
})) || [];

function formatCurrency(amount: number) {
  return `$${amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}
---

<AdminLayout title="Commissions" activeNav="referrals">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold text-admin-cream">Commissions</h2>
    <div class="flex gap-2">
      <Button variant="ghost" size="sm">Export CSV</Button>
    </div>
  </div>

  <div class="bg-primary-cardBlack border border-text-muted rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="text-xs text-text-muted uppercase bg-primary-hoverBlack border-b border-text-muted">
          <tr>
            <th class="px-6 py-3">Date</th>
            <th class="px-6 py-3">Order ID</th>
            <th class="px-6 py-3">Referrer</th>
            <th class="px-6 py-3">Level</th>
            <th class="px-6 py-3">Amount</th>
            <th class="px-6 py-3">Status</th>
            <th class="px-6 py-3"></th>
          </tr>
        </thead>
        <tbody>
          {commissionsWithData.length === 0 ? (
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-text-muted">No commissions found</td>
            </tr>
          ) : (
            commissionsWithData.map((comm) => (
              <tr class="border-b border-text-muted hover:bg-primary-hoverBlack/50 transition-colors">
                <td class="px-6 py-4 text-text-muted">
                  {formatDate(comm.created_at)}
                </td>
                <td class="px-6 py-4 font-mono text-xs text-text-muted">
                  {comm.order_id.substring(0, 8)}...
                </td>
                <td class="px-6 py-4">
                  <span class="font-mono text-accent-gold bg-accent-gold/10 px-2 py-1 rounded text-xs">
                    {comm.referrer_code}
                  </span>
                </td>
                <td class="px-6 py-4 text-text-muted">
                  Level {comm.level}
                </td>
                <td class="px-6 py-4 font-medium text-admin-cream">
                  {formatCurrency(comm.amount)}
                </td>
                <td class="px-6 py-4">
                  <span class={`px-2 py-1 rounded-full text-xs font-medium uppercase ${
                    comm.status === 'paid' ? 'bg-status-success/10 text-status-success' :
                    comm.status === 'pending' ? 'bg-status-warning/10 text-status-warning' :
                    comm.status === 'approved' ? 'bg-status-info/10 text-status-info' :
                    'bg-status-error/10 text-status-error'
                  }`}>
                    {comm.status}
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <Button variant="ghost" size="sm">Details</Button>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>
</AdminLayout>
