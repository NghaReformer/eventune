---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import Modal from '../../../components/ui/Modal.astro';
import Input from '../../../components/ui/Input.astro';
import Button from '../../../components/ui/Button.astro';
import { supabase } from '../../../lib/supabase/client';

// Fetch programs
const { data: programs } = await supabase
  .from('referral_programs')
  .select('*')
  .order('created_at', { ascending: false });
---

<AdminLayout title="Referral Programs" activeNav="referrals">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-semibold text-admin-cream">Programs</h2>
    <Button variant="primary" onclick="document.getElementById('create-program-modal').showModal()">
      Create Program
    </Button>
  </div>

  <!-- Programs List -->
  <div class="grid gap-4">
    {programs?.map((program) => (
      <div class="bg-primary-cardBlack border border-text-muted rounded-lg p-4 flex justify-between items-center">
        <div>
          <div class="flex items-center gap-3">
            <h3 class="text-lg font-medium text-admin-cream">{program.name}</h3>
            {!program.is_active && (
              <span class="text-xs bg-status-error/10 text-status-error px-2 py-1 rounded">Inactive</span>
            )}
          </div>
          <p class="text-sm text-text-muted mt-1">{program.description}</p>
          <div class="flex gap-2 mt-3">
            <span class="text-xs bg-accent-gold/10 text-accent-gold px-2 py-1 rounded font-mono">
              {program.slug}
            </span>
            <span class="text-xs bg-text-muted/10 text-text-muted px-2 py-1 rounded">
              {program.config?.max_levels} Levels
            </span>
            <span class="text-xs bg-text-muted/10 text-text-muted px-2 py-1 rounded">
              {program.config?.lifetime_duration_days ? `${program.config.lifetime_duration_days} Days Cookie` : 'Lifetime Cookie'}
            </span>
          </div>
        </div>
        <div class="flex gap-2">
          <Button variant="ghost" size="sm" class="edit-btn" data-program={JSON.stringify(program)}>Edit</Button>
          <Button variant="ghost" size="sm" class="text-status-error hover:text-red-400 delete-btn" data-id={program.id}>Delete</Button>
        </div>
      </div>
    ))}
    
    {programs?.length === 0 && (
      <div class="text-center py-12 border border-dashed border-text-muted rounded-lg">
        <p class="text-text-muted">No referral programs found.</p>
      </div>
    )}
  </div>

  <!-- Create Modal -->
  <Modal id="create-program-modal" title="Create Referral Program">
    <form id="create-program-form" class="space-y-4">
      <Input name="name" label="Program Name" required placeholder="e.g. Standard Affiliate" />
      <Input name="slug" label="Slug" required placeholder="e.g. standard" />
      <Input name="description" label="Description" placeholder="Brief description" />
      
      <div class="grid grid-cols-2 gap-4">
        <Input type="number" name="max_levels" label="Max Levels" value="2" min="1" max="5" />
        <Input type="number" name="lifetime_duration_days" label="Cookie Duration (Days)" value="30" hint="Leave empty for lifetime" />
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <Button type="button" variant="ghost" data-modal-close>Cancel</Button>
        <Button type="submit" variant="primary">Create Program</Button>
      </div>
    </form>
  </Modal>
  <!-- Edit Modal -->
  <Modal id="edit-program-modal" title="Edit Referral Program">
    <form id="edit-program-form" class="space-y-4">
      <input type="hidden" name="id" />
      <Input name="name" label="Program Name" required />
      <Input name="description" label="Description" />
      
      <div class="grid grid-cols-2 gap-4">
        <Input type="number" name="max_levels" label="Max Levels" min="1" max="5" />
        <Input type="number" name="lifetime_duration_days" label="Cookie Duration (Days)" hint="Empty for lifetime" />
      </div>

       <div class="p-3 bg-primary-dark/50 rounded text-sm text-text-muted">
        <p>⚠️ Commission rates (Levels) editing coming soon. Default is 10% (L1) and 5% (L2).</p>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <Button type="button" variant="ghost" data-modal-close>Cancel</Button>
        <Button type="submit" variant="primary">Save Changes</Button>
      </div>
    </form>
  </Modal>
</AdminLayout>

<script>
  const form = document.getElementById('create-program-form');
  const modal = document.getElementById('create-program-modal');
  const editForm = document.getElementById('edit-program-form');
  const editModal = document.getElementById('edit-program-modal');

  // Handle Create
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target as HTMLFormElement);
    
    // Config Levels (Default setup for new program)
    const levels = [
      { level: 1, commission_type: 'percentage', commission_value: 10 },
      { level: 2, commission_type: 'percentage', commission_value: 5 },
    ];

    const data = {
      name: formData.get('name'),
      slug: formData.get('slug'),
      description: formData.get('description'),
      config: {
        max_levels: Number(formData.get('max_levels')),
        lifetime_duration_days: formData.get('lifetime_duration_days') ? Number(formData.get('lifetime_duration_days')) : null,
      },
      levels // Pass default levels
    };

    try {
      const res = await fetch('/api/admin/referrals/programs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        window.location.reload();
      } else {
        const err = await res.json();
        alert('Error creating program: ' + (err.error || 'Unknown error'));
      }
    } catch (err) {
      console.error(err);
      alert('Error creating program');
    }
  });

  // Handle Edit Click
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const program = JSON.parse((btn as HTMLElement).dataset.program!);
      const modal = document.getElementById('edit-program-modal') as any;
      const form = document.getElementById('edit-program-form') as HTMLFormElement;
      
      // Populate form
      (form.elements.namedItem('id') as HTMLInputElement).value = program.id;
      (form.elements.namedItem('name') as HTMLInputElement).value = program.name;
      (form.elements.namedItem('description') as HTMLInputElement).value = program.description || '';
      (form.elements.namedItem('max_levels') as HTMLInputElement).value = program.config?.max_levels || 2;
      (form.elements.namedItem('lifetime_duration_days') as HTMLInputElement).value = program.config?.lifetime_duration_days || '';
      
      modal?.showModal();
    });
  });

  // Handle Edit Submit
  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target as HTMLFormElement);
    const id = formData.get('id') as string;

    const data = {
      name: formData.get('name'),
      description: formData.get('description'),
      config: {
        max_levels: Number(formData.get('max_levels')),
        lifetime_duration_days: formData.get('lifetime_duration_days') ? Number(formData.get('lifetime_duration_days')) : null,
      }
      // Note: Levels editing not in UI yet, requires complex form.
    };

    try {
      const res = await fetch(`/api/admin/referrals/programs/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        window.location.reload();
      } else {
        alert('Error updating program');
      }
    } catch (err) {
      alert('Error updating program');
    }
  });

  // Handle Delete/Toggle Status
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this program?')) return;
      const id = (btn as HTMLElement).dataset.id;
      
      try {
        const res = await fetch(`/api/admin/referrals/programs/${id}`, {
          method: 'DELETE'
        });
        
        if (res.ok) window.location.reload();
        else alert('Error deleting program');
      } catch (err) {
        alert('Error deleting');
      }
    });
  });
</script>
