---
/**
 * Reset Password Page
 * Set new password after clicking reset link
 */

import AuthLayout from '@/layouts/AuthLayout.astro';
import Card from '@/components/ui/Card.astro';
import Button from '@/components/ui/Button.astro';
---

<AuthLayout title="Reset Password | Eventune Studios" description="Set your new password">
  <Card variant="elevated" class="p-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-accent-gold/10 flex items-center justify-center">
        <svg class="w-8 h-8 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      <h1 class="text-2xl font-heading font-bold text-text-primary mb-2">
        Set New Password
      </h1>
      <p class="text-text-secondary">
        Create a strong password for your account
      </p>
    </div>

    <!-- Invalid Link State -->
    <div id="invalid-state" class="hidden text-center py-4">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-status-error/20 flex items-center justify-center">
        <svg class="w-8 h-8 text-status-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <h2 class="text-xl font-heading font-bold text-text-primary mb-2">
        Invalid or Expired Link
      </h2>
      <p class="text-text-secondary mb-6">
        This password reset link is invalid or has expired. Please request a new one.
      </p>
      <a
        href="/auth/forgot-password"
        class="inline-flex items-center justify-center px-6 py-3 bg-accent-gold text-primary-black rounded-lg hover:bg-accent-goldHover transition-colors"
      >
        Request New Link
      </a>
    </div>

    <!-- Success State -->
    <div id="success-state" class="hidden text-center py-4">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-status-success/20 flex items-center justify-center">
        <svg class="w-8 h-8 text-status-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h2 class="text-xl font-heading font-bold text-text-primary mb-2">
        Password Updated
      </h2>
      <p class="text-text-secondary mb-6">
        Your password has been successfully updated. You can now sign in with your new password.
      </p>
      <a
        href="/auth/login"
        class="inline-flex items-center justify-center px-6 py-3 bg-accent-gold text-primary-black rounded-lg hover:bg-accent-goldHover transition-colors"
      >
        Sign In
      </a>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-8">
      <div class="w-12 h-12 mx-auto mb-4 border-4 border-accent-gold/30 border-t-accent-gold rounded-full animate-spin"></div>
      <p class="text-text-secondary">Verifying your reset link...</p>
    </div>

    <!-- Reset Form -->
    <form id="reset-form" class="hidden space-y-6">
      <div>
        <label for="password" class="block text-sm font-medium text-text-primary mb-2">
          New Password
        </label>
        <input
          type="password"
          id="password"
          name="password"
          required
          autocomplete="new-password"
          minlength="8"
          class="w-full px-4 py-3 bg-primary-cardBlack border border-text-muted/30 rounded-lg text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-accent-gold/50 focus:border-accent-gold transition-colors"
          placeholder="Enter new password (min. 8 characters)"
        />
        <div id="password-strength" class="mt-2 hidden">
          <div class="flex gap-1">
            <div class="h-1 flex-1 rounded bg-text-muted/30 strength-bar"></div>
            <div class="h-1 flex-1 rounded bg-text-muted/30 strength-bar"></div>
            <div class="h-1 flex-1 rounded bg-text-muted/30 strength-bar"></div>
            <div class="h-1 flex-1 rounded bg-text-muted/30 strength-bar"></div>
          </div>
          <p class="text-xs mt-1 strength-text text-text-muted"></p>
        </div>
      </div>

      <div>
        <label for="confirmPassword" class="block text-sm font-medium text-text-primary mb-2">
          Confirm New Password
        </label>
        <input
          type="password"
          id="confirmPassword"
          name="confirmPassword"
          required
          autocomplete="new-password"
          minlength="8"
          class="w-full px-4 py-3 bg-primary-cardBlack border border-text-muted/30 rounded-lg text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-accent-gold/50 focus:border-accent-gold transition-colors"
          placeholder="Confirm new password"
        />
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden p-4 bg-status-error/20 border border-status-error rounded-lg text-status-error text-sm">
      </div>

      <Button type="submit" variant="primary" size="lg" fullWidth id="submit-btn">
        Update Password
      </Button>
    </form>
  </Card>
</AuthLayout>

<script>
  import { supabase } from '@/lib/supabase/client';

  const form = document.getElementById('reset-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorMessage = document.getElementById('error-message') as HTMLElement;
  const invalidState = document.getElementById('invalid-state') as HTMLElement;
  const successState = document.getElementById('success-state') as HTMLElement;
  const loadingState = document.getElementById('loading-state') as HTMLElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const passwordStrength = document.getElementById('password-strength') as HTMLElement;

  // Password strength checker
  function checkPasswordStrength(password: string): { score: number; text: string; color: string } {
    let score = 0;

    if (password.length >= 8) score++;
    if (password.length >= 12) score++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
    if (/\d/.test(password)) score++;
    if (/[^a-zA-Z0-9]/.test(password)) score++;

    if (score <= 1) return { score: 1, text: 'Weak', color: 'bg-status-error' };
    if (score <= 2) return { score: 2, text: 'Fair', color: 'bg-status-warning' };
    if (score <= 3) return { score: 3, text: 'Good', color: 'bg-status-info' };
    return { score: 4, text: 'Strong', color: 'bg-status-success' };
  }

  passwordInput?.addEventListener('input', () => {
    const password = passwordInput.value;
    if (password.length === 0) {
      passwordStrength?.classList.add('hidden');
      return;
    }

    passwordStrength?.classList.remove('hidden');
    const strength = checkPasswordStrength(password);

    const bars = passwordStrength.querySelectorAll('.strength-bar');
    const text = passwordStrength.querySelector('.strength-text');

    bars.forEach((bar, index) => {
      bar.className = 'h-1 flex-1 rounded strength-bar ' +
        (index < strength.score ? strength.color : 'bg-text-muted/30');
    });

    if (text) {
      text.textContent = strength.text;
      text.className = 'text-xs mt-1 strength-text ' + strength.color.replace('bg-', 'text-');
    }
  });

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage?.classList.remove('hidden');
  }

  function hideError() {
    errorMessage?.classList.add('hidden');
  }

  function showInvalid() {
    loadingState?.classList.add('hidden');
    form?.classList.add('hidden');
    invalidState?.classList.remove('hidden');
  }

  function showSuccess() {
    form?.classList.add('hidden');
    successState?.classList.remove('hidden');
  }

  function showForm() {
    loadingState?.classList.add('hidden');
    form?.classList.remove('hidden');
  }

  // Check for valid session from reset link
  async function checkSession() {
    // Supabase handles the token exchange automatically when the page loads
    // with the access_token and refresh_token in the URL hash
    const { data: { session }, error } = await supabase.auth.getSession();

    if (error || !session) {
      // Try to exchange tokens from URL hash
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');

      if (accessToken && refreshToken) {
        const { error: setError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        });

        if (setError) {
          showInvalid();
          return;
        }

        showForm();
        // Clear hash from URL
        history.replaceState(null, '', window.location.pathname);
      } else {
        showInvalid();
      }
    } else {
      showForm();
    }
  }

  checkSession();

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const formData = new FormData(form);
    const password = formData.get('password') as string;
    const confirmPassword = formData.get('confirmPassword') as string;

    // Validate passwords match
    if (password !== confirmPassword) {
      showError('Passwords do not match.');
      return;
    }

    // Validate password strength
    const strength = checkPasswordStrength(password);
    if (strength.score < 2) {
      showError('Please choose a stronger password. Include uppercase, lowercase, numbers, and special characters.');
      return;
    }

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';

    try {
      const { error } = await supabase.auth.updateUser({
        password: password,
      });

      if (error) {
        showError(error.message);
        return;
      }

      // Sign out after password update
      await supabase.auth.signOut();
      showSuccess();

    } catch (err) {
      showError('An unexpected error occurred. Please try again.');
      console.error('Password update error:', err);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Password';
    }
  });
</script>
