---
/**
 * Forgot Password Page
 * Request password reset email
 */

import AuthLayout from '@/layouts/AuthLayout.astro';
import Card from '@/components/ui/Card.astro';
import Input from '@/components/ui/Input.astro';
import Button from '@/components/ui/Button.astro';
---

<AuthLayout title="Forgot Password | Eventune Studios" description="Reset your Eventune Studios password">
  <Card variant="elevated" class="p-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-accent-gold/10 flex items-center justify-center">
        <svg class="w-8 h-8 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
        </svg>
      </div>
      <h1 class="text-2xl font-heading font-bold text-text-primary mb-2">
        Forgot Your Password?
      </h1>
      <p class="text-text-secondary">
        No worries! Enter your email and we'll send you a reset link.
      </p>
    </div>

    <!-- Success State -->
    <div id="success-state" class="hidden text-center py-4">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-status-success/20 flex items-center justify-center">
        <svg class="w-8 h-8 text-status-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>
      <h2 class="text-xl font-heading font-bold text-text-primary mb-2">
        Check Your Email
      </h2>
      <p class="text-text-secondary mb-6">
        If an account exists for <span id="success-email" class="text-accent-gold"></span>, you'll receive a password reset link shortly.
      </p>
      <p class="text-text-muted text-sm mb-6">
        Didn't receive the email? Check your spam folder or wait a few minutes and try again.
      </p>
      <a
        href="/auth/login"
        class="inline-flex items-center justify-center px-6 py-3 border border-text-muted text-text-primary rounded-lg hover:border-accent-gold hover:text-accent-gold transition-colors"
      >
        Back to Login
      </a>
    </div>

    <!-- Reset Form -->
    <form id="reset-form" class="space-y-6">
      <Input
        label="Email Address"
        name="email"
        type="email"
        placeholder="you@example.com"
        required
        autocomplete="email"
      />

      <!-- Error Message -->
      <div id="error-message" class="hidden p-4 bg-status-error/20 border border-status-error rounded-lg text-status-error text-sm">
      </div>

      <Button type="submit" variant="primary" size="lg" fullWidth id="submit-btn">
        Send Reset Link
      </Button>

      <p class="text-center">
        <a
          href="/auth/login"
          class="text-sm text-text-secondary hover:text-accent-gold transition-colors"
        >
          &larr; Back to Login
        </a>
      </p>
    </form>
  </Card>
</AuthLayout>

<script>
  import { supabase } from '@/lib/supabase/client';

  const form = document.getElementById('reset-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorMessage = document.getElementById('error-message') as HTMLElement;
  const successState = document.getElementById('success-state') as HTMLElement;
  const successEmail = document.getElementById('success-email') as HTMLElement;

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage?.classList.remove('hidden');
  }

  function hideError() {
    errorMessage?.classList.add('hidden');
  }

  function showSuccess(email: string) {
    form?.classList.add('hidden');
    successState?.classList.remove('hidden');
    if (successEmail) successEmail.textContent = email;
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const formData = new FormData(form);
    const email = formData.get('email') as string;

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/auth/reset-password`,
      });

      if (error) {
        // Don't reveal if email exists or not for security
        console.error('Reset password error:', error);
      }

      // Always show success (don't reveal if email exists)
      showSuccess(email);

    } catch (err) {
      showError('An unexpected error occurred. Please try again.');
      console.error('Reset password error:', err);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Reset Link';
    }
  });
</script>
