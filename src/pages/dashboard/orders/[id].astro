---
/**
 * Order Details Page
 * Full order info, status timeline, song download, revision request
 *
 * Security: Uses session from layout, server-side data fetching,
 * IDOR protection via ownership validation
 */
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { getServerClient } from '../../../lib/supabase/server';
import type { SessionData } from '../../../lib/auth/session';
import { isValidUUID, validateOrderOwnership } from '../../../lib/security/validation';

const { id } = Astro.params;

// Get session from layout (already validated)
const session = Astro.locals.session as SessionData | undefined;
const csrfToken = Astro.locals.csrfToken as string;

if (!session) {
  return Astro.redirect('/auth/login?redirect=/dashboard/orders');
}

const { user } = session;

// Validate UUID format to prevent injection
if (!id || !isValidUUID(id)) {
  return Astro.redirect('/dashboard/orders');
}

// Fetch order using server client
const supabase = getServerClient();
let order: any = null;
let statusHistory: any[] = [];
let questionnaire: any = null;
let fetchError: string | null = null;

try {
  // Fetch order - note: we fetch by ID only, then verify ownership
  // This provides clearer error messages and prevents timing attacks
  const { data: orderData, error } = await supabase
    .from('orders')
    .select('*')
    .eq('id', id)
    .single();

  // IDOR Protection: Verify order belongs to current user
  if (!validateOrderOwnership(orderData, user.id)) {
    console.warn(`IDOR attempt: User ${user.id} tried to access order ${id}`);
    return Astro.redirect('/dashboard/orders');
  }

  if (error) {
    console.error('Error fetching order:', error);
    fetchError = 'Unable to load order details.';
  } else {
    order = orderData;

    // Fetch status history
    const { data: historyData } = await supabase
      .from('order_status_history')
      .select('*')
      .eq('order_id', id)
      .order('created_at', { ascending: true });

    statusHistory = historyData || [];

    // Fetch questionnaire if exists
    if (order.questionnaire_id) {
      const { data: questionnaireData } = await supabase
        .from('questionnaires')
        .select('*')
        .eq('id', order.questionnaire_id)
        .single();

      questionnaire = questionnaireData;
    }
  }
} catch (err) {
  console.error('Order fetch error:', err);
  fetchError = 'Something went wrong. Please try again.';
}

if (!order) {
  return Astro.redirect('/dashboard/orders');
}

// Status configurations
const statusConfig: Record<string, { label: string; color: string; icon: string }> = {
  pending: { label: 'Pending', color: 'amber', icon: 'clock' },
  payment_pending: { label: 'Payment Pending', color: 'amber', icon: 'credit-card' },
  paid: { label: 'Paid', color: 'emerald', icon: 'check' },
  in_progress: { label: 'In Progress', color: 'blue', icon: 'play' },
  composing: { label: 'Composing', color: 'blue', icon: 'music' },
  recording: { label: 'Recording', color: 'purple', icon: 'microphone' },
  mixing: { label: 'Mixing', color: 'indigo', icon: 'sliders' },
  review: { label: 'In Review', color: 'cyan', icon: 'eye' },
  revision: { label: 'Revision', color: 'orange', icon: 'refresh' },
  completed: { label: 'Completed', color: 'emerald', icon: 'check-circle' },
  delivered: { label: 'Delivered', color: 'gold', icon: 'download' },
  cancelled: { label: 'Cancelled', color: 'red', icon: 'x' },
  refunded: { label: 'Refunded', color: 'gray', icon: 'arrow-left' },
};

function getStatusConfig(status: string) {
  return statusConfig[status] || { label: status, color: 'gray', icon: 'circle' };
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric'
  });
}

function formatDateTime(date: string) {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit'
  });
}

function formatCurrency(amount: number, currency: string) {
  if (currency === 'XAF') {
    return `${amount.toLocaleString()} XAF`;
  }
  return `$${amount.toFixed(2)}`;
}

function formatOccasion(slug: string | null) {
  if (!slug) return 'Custom Song';
  return slug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatPackage(slug: string | null) {
  if (!slug) return 'Standard';
  return slug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

const currentStatus = getStatusConfig(order.status);
const isDelivered = order.status === 'delivered';
const canRequestRevision = ['completed', 'delivered'].includes(order.status);
const isPaid = order.payment_status === 'paid';
---

<DashboardLayout title={`Order ${order.order_number}`} activeNav="orders">
  <!-- Back Link -->
  <a
    href="/dashboard/orders"
    class="inline-flex items-center gap-2 text-studio-cream/50 hover:text-gold mb-6 transition-colors"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back to Orders
  </a>

  <div class="grid lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-8">
      <!-- Order Header Card -->
      <div class="order-card">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
          <div>
            <div class="flex items-center gap-3 mb-2">
              <span class="font-mono text-lg text-gold">{order.order_number}</span>
              <span class={`status-badge status-${currentStatus.color}`}>
                <span class="status-dot"></span>
                {currentStatus.label}
              </span>
            </div>
            <p class="text-studio-cream/50">Created on {formatDate(order.created_at)}</p>
          </div>

          {isDelivered && order.delivery_url && (
            <a
              href={order.delivery_url}
              download
              class="download-btn group"
            >
              <div class="download-icon">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </div>
              <span>Download Your Song</span>
            </a>
          )}
        </div>

        <!-- Order Details Grid -->
        <div class="grid sm:grid-cols-2 gap-6">
          <div class="detail-item">
            <span class="detail-label">Occasion</span>
            <span class="detail-value">{formatOccasion(order.occasion_slug)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Package</span>
            <span class="detail-value">{formatPackage(order.package_slug)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Amount</span>
            <span class="detail-value text-gold">{formatCurrency(order.amount_expected, order.currency)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Payment Status</span>
            <span class={`detail-value ${isPaid ? 'text-emerald-400' : 'text-amber-400'}`}>
              {isPaid ? 'Paid' : 'Pending'}
            </span>
          </div>
          {order.due_date && (
            <div class="detail-item">
              <span class="detail-label">Expected Delivery</span>
              <span class="detail-value">{formatDate(order.due_date)}</span>
            </div>
          )}
          {order.song_title && (
            <div class="detail-item">
              <span class="detail-label">Song Title</span>
              <span class="detail-value">{order.song_title}</span>
            </div>
          )}
        </div>
      </div>

      <!-- Status Timeline -->
      <div class="order-card">
        <h3 class="font-display text-xl text-studio-cream mb-6">Order Timeline</h3>

        {statusHistory.length === 0 ? (
          <div class="text-center py-8 text-studio-cream/50">
            <p>Status updates will appear here as your order progresses.</p>
          </div>
        ) : (
          <div class="timeline">
            {statusHistory.map((event, index) => {
              const config = getStatusConfig(event.status);
              const isLast = index === statusHistory.length - 1;
              return (
                <div class="timeline-item">
                  <div class={`timeline-dot ${isLast ? 'active' : ''} dot-${config.color}`}>
                    {isLast && <span class="pulse-ring"></span>}
                  </div>
                  {!isLast && <div class="timeline-line"></div>}
                  <div class="timeline-content">
                    <div class="flex items-center gap-2 mb-1">
                      <span class={`font-semibold text-${config.color}-400`}>{config.label}</span>
                    </div>
                    {event.note && (
                      <p class="text-studio-cream/70 text-sm mb-1">{event.note}</p>
                    )}
                    <p class="text-studio-cream/40 text-xs">{formatDateTime(event.created_at)}</p>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      <!-- Revision Request -->
      {canRequestRevision && (
        <div class="order-card border-orange-500/20">
          <h3 class="font-display text-xl text-studio-cream mb-4">Request Revision</h3>
          <p class="text-studio-cream/60 mb-6">
            Not quite right? Let us know what adjustments you'd like and we'll make it perfect.
          </p>
          <form id="revision-form" class="space-y-4" method="POST" action="/api/orders/revision">
            <input type="hidden" name="csrf_token" value={csrfToken} />
            <input type="hidden" name="order_id" value={order.id} />
            <div>
              <label for="revision-notes" class="block text-sm text-studio-cream/70 mb-2">
                What would you like changed?
              </label>
              <textarea
                id="revision-notes"
                name="notes"
                rows={4}
                class="form-textarea"
                placeholder="Describe the changes you'd like..."
                required
              ></textarea>
            </div>
            <button type="submit" class="revision-btn">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Request Revision
            </button>
          </form>
        </div>
      )}
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Payment Summary -->
      <div class="sidebar-card">
        <h4 class="font-display text-lg text-studio-cream mb-4">Payment Summary</h4>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-studio-cream/60">{formatPackage(order.package_slug)} Package</span>
            <span class="text-studio-cream">{formatCurrency(order.amount_expected, order.currency)}</span>
          </div>
          <div class="border-t border-gold/10 pt-3 flex justify-between">
            <span class="font-semibold text-studio-cream">Total</span>
            <span class="font-bold text-gold text-lg">{formatCurrency(order.amount_expected, order.currency)}</span>
          </div>
        </div>

        {!isPaid && (
          <a
            href={`/order/checkout?order=${order.id}`}
            class="mt-6 w-full inline-flex items-center justify-center gap-2 px-6 py-3 bg-gold text-studio-black font-semibold rounded-lg hover:bg-gold-dark transition-colors"
          >
            Complete Payment
          </a>
        )}
      </div>

      <!-- Quick Actions -->
      <div class="sidebar-card">
        <h4 class="font-display text-lg text-studio-cream mb-4">Quick Actions</h4>
        <div class="space-y-3">
          <a href="/contact" class="action-link">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
            Contact Support
          </a>
          <a href="/services" class="action-link">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" />
            </svg>
            Order Another Song
          </a>
        </div>
      </div>

      <!-- Need Help -->
      <div class="sidebar-card bg-gold/5 border-gold/20">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-gold/20 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h5 class="font-semibold text-studio-cream mb-1">Need Help?</h5>
            <p class="text-sm text-studio-cream/60">
              Our team is here to help with any questions about your order.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<style>
  :root {
    --studio-black: #0A0A0A;
    --studio-card: #141414;
    --studio-cream: #F5F5F5;
    --gold: #D4AF37;
    --gold-dark: #B8962E;
  }

  .bg-studio-black { background-color: var(--studio-black); }
  .bg-studio-card { background-color: var(--studio-card); }
  .text-studio-cream { color: var(--studio-cream); }
  .text-gold { color: var(--gold); }
  .bg-gold { background-color: var(--gold); }
  .border-gold { border-color: var(--gold); }
  .font-display { font-family: 'Playfair Display', serif; }

  .order-card {
    @apply bg-studio-card border border-gold/10 rounded-xl p-6;
  }

  .sidebar-card {
    @apply bg-studio-card border border-gold/10 rounded-xl p-5;
  }

  .status-badge {
    @apply inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium uppercase tracking-wider;
  }

  .status-dot {
    @apply w-2 h-2 rounded-full;
  }

  .status-amber { @apply bg-amber-500/10 text-amber-400; }
  .status-amber .status-dot { @apply bg-amber-400; }

  .status-emerald { @apply bg-emerald-500/10 text-emerald-400; }
  .status-emerald .status-dot { @apply bg-emerald-400; }

  .status-blue { @apply bg-blue-500/10 text-blue-400; }
  .status-blue .status-dot { @apply bg-blue-400; }

  .status-purple { @apply bg-purple-500/10 text-purple-400; }
  .status-purple .status-dot { @apply bg-purple-400; }

  .status-indigo { @apply bg-indigo-500/10 text-indigo-400; }
  .status-indigo .status-dot { @apply bg-indigo-400; }

  .status-cyan { @apply bg-cyan-500/10 text-cyan-400; }
  .status-cyan .status-dot { @apply bg-cyan-400; }

  .status-orange { @apply bg-orange-500/10 text-orange-400; }
  .status-orange .status-dot { @apply bg-orange-400; }

  .status-gold { @apply bg-gold/10 text-gold; }
  .status-gold .status-dot { @apply bg-gold; }

  .status-red { @apply bg-red-500/10 text-red-400; }
  .status-red .status-dot { @apply bg-red-400; }

  .status-gray { @apply bg-gray-500/10 text-gray-400; }
  .status-gray .status-dot { @apply bg-gray-400; }

  .detail-item {
    @apply flex flex-col gap-1;
  }

  .detail-label {
    @apply text-sm text-studio-cream/50;
  }

  .detail-value {
    @apply text-lg text-studio-cream font-medium;
  }

  .download-btn {
    @apply inline-flex items-center gap-3 px-6 py-3;
    @apply bg-gradient-to-r from-gold to-gold-dark text-studio-black font-semibold rounded-lg;
    @apply hover:shadow-lg hover:shadow-gold/30 transition-all duration-300;
  }

  .download-icon {
    @apply w-10 h-10 rounded-full bg-studio-black/20 flex items-center justify-center;
    @apply group-hover:scale-110 transition-transform;
  }

  .revision-btn {
    @apply inline-flex items-center gap-2 px-6 py-3;
    @apply border border-orange-500/30 text-orange-400 font-medium rounded-lg;
    @apply hover:bg-orange-500/10 hover:border-orange-500/50 transition-all;
  }

  .form-textarea {
    @apply w-full bg-studio-black border border-gold/20 rounded-lg px-4 py-3;
    @apply text-studio-cream placeholder-studio-cream/30;
    @apply focus:outline-none focus:border-gold/50 transition-colors;
    @apply resize-none;
  }

  .action-link {
    @apply flex items-center gap-3 px-4 py-3 rounded-lg;
    @apply text-studio-cream/70 hover:text-gold hover:bg-gold/5;
    @apply transition-all duration-200;
  }

  /* Timeline */
  .timeline {
    @apply relative;
  }

  .timeline-item {
    @apply relative pl-8 pb-8 last:pb-0;
  }

  .timeline-dot {
    @apply absolute left-0 top-0 w-4 h-4 rounded-full border-2 bg-studio-card;
    @apply flex items-center justify-center;
  }

  .timeline-dot.active {
    @apply ring-4 ring-opacity-20;
  }

  .dot-amber { @apply border-amber-400; }
  .dot-amber.active { @apply bg-amber-400 ring-amber-400; }

  .dot-emerald { @apply border-emerald-400; }
  .dot-emerald.active { @apply bg-emerald-400 ring-emerald-400; }

  .dot-blue { @apply border-blue-400; }
  .dot-blue.active { @apply bg-blue-400 ring-blue-400; }

  .dot-purple { @apply border-purple-400; }
  .dot-purple.active { @apply bg-purple-400 ring-purple-400; }

  .dot-indigo { @apply border-indigo-400; }
  .dot-indigo.active { @apply bg-indigo-400 ring-indigo-400; }

  .dot-cyan { @apply border-cyan-400; }
  .dot-cyan.active { @apply bg-cyan-400 ring-cyan-400; }

  .dot-orange { @apply border-orange-400; }
  .dot-orange.active { @apply bg-orange-400 ring-orange-400; }

  .dot-gold { @apply border-gold; }
  .dot-gold.active { @apply bg-gold ring-gold; }

  .dot-red { @apply border-red-400; }
  .dot-red.active { @apply bg-red-400 ring-red-400; }

  .dot-gray { @apply border-gray-400; }
  .dot-gray.active { @apply bg-gray-400 ring-gray-400; }

  .timeline-line {
    @apply absolute left-[7px] top-4 bottom-0 w-0.5 bg-gold/20;
  }

  .timeline-content {
    @apply ml-2;
  }

  .pulse-ring {
    @apply absolute inset-0 rounded-full animate-ping opacity-75;
    background: inherit;
  }

  /* Color text utilities */
  .text-amber-400 { color: #fbbf24; }
  .text-emerald-400 { color: #34d399; }
  .text-blue-400 { color: #60a5fa; }
  .text-purple-400 { color: #c084fc; }
  .text-indigo-400 { color: #818cf8; }
  .text-cyan-400 { color: #22d3ee; }
  .text-orange-400 { color: #fb923c; }
  .text-red-400 { color: #f87171; }
  .text-gray-400 { color: #9ca3af; }
</style>

<script>
  // Helper to show toast messages
  function showToast(message: string, type: 'success' | 'error' = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg font-medium z-50 transition-opacity duration-300 max-w-sm ${
      type === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Revision form submission
  const form = document.getElementById('revision-form') as HTMLFormElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Submitting...
    `;

    try {
      const response = await fetch('/api/orders/revision', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (response.ok) {
        showToast(result.message || 'Revision request submitted successfully!', 'success');
        form.reset();
        // Optionally reload to show updated status
        setTimeout(() => window.location.reload(), 2000);
      } else {
        showToast(result.error || 'Failed to submit revision request', 'error');
      }
    } catch {
      showToast('An unexpected error occurred. Please try again.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Request Revision
      `;
    }
  });
</script>
