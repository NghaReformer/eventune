---
/**
 * Services Page
 * Product-based pricing with song tiers, video add-ons, and bundles
 */

import PublicLayout from '@/layouts/PublicLayout.astro';
import Card from '@/components/ui/Card.astro';
import Badge from '@/components/ui/Badge.astro';
import { siteConfig } from '@/config';
import {
  getPackages,
  getVideoProducts,
  getAddonsByCategory,
  getBundles,
  type Package,
  type VideoProduct,
  type Addon,
  type Bundle,
} from '@/services/config.service';

// Fetch all pricing data
let packages: Package[] = [];
let videoProducts: VideoProduct[] = [];
let deliveryAddons: Addon[] = [];
let revisionAddons: Addon[] = [];
let licenseAddons: Addon[] = [];
let extraAddons: Addon[] = [];
let physicalAddons: Addon[] = [];
let bundles: Bundle[] = [];

try {
  [packages, videoProducts, deliveryAddons, revisionAddons, licenseAddons, extraAddons, physicalAddons, bundles] =
    await Promise.all([
      getPackages(),
      getVideoProducts(),
      getAddonsByCategory('delivery'),
      getAddonsByCategory('revision'),
      getAddonsByCategory('license'),
      getAddonsByCategory('extra'),
      getAddonsByCategory('physical'),
      getBundles(),
    ]);
} catch (error) {
  console.error('Error fetching pricing data:', error);
}

// Format song length (now in minutes as decimals)
const formatSongLength = (min: number, max: number) => {
  const formatTime = (minutes: number) => {
    if (minutes < 1) {
      return `${Math.round(minutes * 60)}s`;
    }
    const mins = Math.floor(minutes);
    const secs = Math.round((minutes - mins) * 60);
    if (secs === 0) return `${mins}:00`;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return `${formatTime(min)} - ${formatTime(max)}`;
};

// Format delivery time
const formatDelivery = (min: number, max: number) => {
  if (min === max) return `${min} days`;
  return `${min}-${max} days`;
};

// Helper to format price
const formatPrice = (price: number, currency: 'USD' | 'XAF') => {
  if (currency === 'USD') {
    return `$${price}`;
  } else {
    return `${price.toLocaleString()} CFA`;
  }
};
---

<PublicLayout
  title="Services & Pricing | Eventune Studios"
  description="Choose the perfect song tier and add-ons for your custom song. From quick tunes to epic productions with full rights ownership."
>
  <!-- Hero Section -->
  <section class="py-16 md:py-24 bg-primary-cardBlack">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h1 class="text-4xl md:text-5xl font-heading font-bold text-text-primary mb-4">
        Services & Pricing
      </h1>
      <p class="text-lg text-text-secondary max-w-2xl mx-auto">
        Build your perfect custom song package with flexible pricing. Start with a song tier, then add videos, licenses, and more.
      </p>
    </div>
  </section>

  <!-- Currency Toggle -->
  <section class="py-8 border-b border-text-muted/20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-center">
        <div class="inline-flex items-center gap-2 p-1 bg-primary-cardBlack rounded-lg" id="currency-toggle">
          <button
            type="button"
            class="px-4 py-2 text-sm font-medium rounded-md transition-colors currency-btn active"
            data-currency="USD"
          >
            USD ($)
          </button>
          <button
            type="button"
            class="px-4 py-2 text-sm font-medium rounded-md transition-colors currency-btn"
            data-currency="XAF"
          >
            XAF (CFA)
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Song Tiers -->
  <section class="py-16 md:py-24">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-heading font-bold text-text-primary mb-4">
          Song Tiers
        </h2>
        <p class="text-lg text-text-secondary">
          Choose your base song tier, then customize with add-ons below.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
        {packages.map((pkg) => (
          <Card
            variant={pkg.is_popular ? 'bordered' : 'elevated'}
            class={`relative flex flex-col ${pkg.is_popular ? 'border-accent-gold lg:scale-105 lg:z-10' : ''}`}
          >
            {pkg.is_popular && (
              <div class="absolute -top-3 left-1/2 -translate-x-1/2">
                <Badge variant="gold">Most Popular</Badge>
              </div>
            )}

            <div class="flex-1">
              <h3 class="text-2xl font-heading font-bold text-text-primary mb-2">{pkg.name}</h3>
              <p class="text-text-secondary text-sm mb-6 min-h-[60px]">{pkg.description}</p>

              <!-- Price -->
              <div class="mb-6">
                <div class="price-display" data-usd={pkg.price_usd} data-xaf={pkg.price_xaf}>
                  <span class="text-4xl font-bold text-accent-gold price-value">${pkg.price_usd}</span>
                  <span class="text-text-muted text-sm ml-1 price-currency">USD</span>
                </div>
              </div>

              <!-- Features List -->
              <ul class="space-y-3 mb-8">
                <li class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-accent-gold mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                  <span class="text-text-secondary">
                    <strong class="text-text-primary">Song Length:</strong> {formatSongLength(pkg.song_length_min, pkg.song_length_max)}
                  </span>
                </li>
                <li class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-accent-gold mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                  <span class="text-text-secondary">
                    <strong class="text-text-primary">Delivery:</strong> {formatDelivery(pkg.delivery_days_min, pkg.delivery_days_max)}
                  </span>
                </li>
                <li class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-accent-gold mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                  <span class="text-text-secondary">
                    <strong class="text-text-primary">Revisions:</strong> {pkg.revision_count}
                  </span>
                </li>
                {pkg.includes_discovery_call && (
                  <li class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-accent-gold mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-text-secondary">Discovery call included</span>
                  </li>
                )}
                {pkg.includes_instrumental && (
                  <li class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-accent-gold mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-text-secondary">Instrumental track included</span>
                  </li>
                )}
              </ul>
            </div>

            <!-- CTA Button -->
            <a
              href={`/order/wedding?package=${pkg.slug}`}
              class={`block w-full px-6 py-3 text-center font-medium rounded-lg transition-colors ${
                pkg.is_popular
                  ? 'bg-accent-gold text-primary-black hover:bg-accent-goldHover'
                  : 'border border-text-muted text-text-primary hover:border-accent-gold hover:text-accent-gold'
              }`}
            >
              Choose {pkg.name}
            </a>
          </Card>
        ))}
      </div>
    </div>
  </section>

  <!-- Video Add-ons -->
  {videoProducts.length > 0 && (
    <section class="py-16 md:py-24 bg-primary-cardBlack">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-heading font-bold text-text-primary mb-4">
            Video Add-ons
          </h2>
          <p class="text-lg text-text-secondary">
            Bring your song to life with a professional video.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {videoProducts.map((video) => (
            <Card variant="default">
              <div class="flex justify-between items-start mb-3">
                <h3 class="text-xl font-heading font-semibold text-text-primary">{video.name}</h3>
                <Badge variant={video.category === 'lyric_video' ? 'default' : 'gold'}>
                  {video.category === 'lyric_video' ? 'Lyric' : 'Music'}
                </Badge>
              </div>
              <p class="text-text-secondary text-sm mb-4">{video.description}</p>
              <div class="flex justify-between items-center">
                <div class="price-display" data-usd={video.price_usd} data-xaf={video.price_xaf}>
                  <span class="text-2xl font-bold text-accent-gold price-value">${video.price_usd}</span>
                  <span class="text-text-muted text-xs ml-1 price-currency">USD</span>
                </div>
                <span class="text-text-muted text-sm">+{video.delivery_days_additional} days</span>
              </div>
            </Card>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Other Add-ons -->
  <section class="py-16 md:py-24">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-heading font-bold text-text-primary mb-4">
          Customize Your Order
        </h2>
        <p class="text-lg text-text-secondary">
          Add extra features to make your song perfect.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Delivery Add-ons -->
        {deliveryAddons.map((addon) => (
          <Card variant="default">
            <h4 class="text-lg font-heading font-semibold text-text-primary mb-2">{addon.name}</h4>
            <p class="text-text-secondary text-sm mb-4">{addon.description}</p>
            <div class="price-display" data-usd={addon.price_usd} data-xaf={addon.price_xaf} data-percentage={addon.percentage}>
              {addon.price_type === 'fixed' ? (
                <span class="text-xl font-bold text-accent-gold price-value">${addon.price_usd}</span>
              ) : (
                <span class="text-xl font-bold text-accent-gold">+{addon.percentage}%</span>
              )}
            </div>
          </Card>
        ))}

        <!-- Revision Add-ons -->
        {revisionAddons.map((addon) => (
          <Card variant="default">
            <h4 class="text-lg font-heading font-semibold text-text-primary mb-2">{addon.name}</h4>
            <p class="text-text-secondary text-sm mb-4">{addon.description}</p>
            <div class="price-display" data-usd={addon.price_usd} data-xaf={addon.price_xaf}>
              <span class="text-xl font-bold text-accent-gold price-value">${addon.price_usd}</span>
            </div>
          </Card>
        ))}

        <!-- Extra Features -->
        {extraAddons.map((addon) => (
          <Card variant="default">
            <h4 class="text-lg font-heading font-semibold text-text-primary mb-2">{addon.name}</h4>
            <p class="text-text-secondary text-sm mb-4">{addon.description}</p>
            <div class="price-display" data-usd={addon.price_usd} data-xaf={addon.price_xaf}>
              <span class="text-xl font-bold text-accent-gold price-value">${addon.price_usd}</span>
            </div>
          </Card>
        ))}

        <!-- License Add-ons -->
        {licenseAddons.map((addon) => (
          <Card variant="default">
            <h4 class="text-lg font-heading font-semibold text-text-primary mb-2">{addon.name}</h4>
            <p class="text-text-secondary text-sm mb-4">{addon.description}</p>
            <div class="price-display" data-usd={addon.price_usd} data-xaf={addon.price_xaf}>
              <span class="text-xl font-bold text-accent-gold price-value">${addon.price_usd}</span>
            </div>
          </Card>
        ))}

        <!-- Physical Products -->
        {physicalAddons.map((addon) => (
          <Card variant="default">
            <h4 class="text-lg font-heading font-semibold text-text-primary mb-2">{addon.name}</h4>
            <p class="text-text-secondary text-sm mb-4">{addon.description}</p>
            <div class="price-display" data-usd={addon.price_usd} data-xaf={addon.price_xaf}>
              <span class="text-xl font-bold text-accent-gold price-value">${addon.price_usd}</span>
            </div>
          </Card>
        ))}
      </div>
    </div>
  </section>

  <!-- Bundles -->
  {bundles.length > 0 && (
    <section class="py-16 md:py-24 bg-primary-cardBlack">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-heading font-bold text-text-primary mb-4">
            Multi-Song Bundles
          </h2>
          <p class="text-lg text-text-secondary">
            Save big when ordering multiple songs at once.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
          {bundles.map((bundle) => (
            <Card variant="elevated" class="text-center">
              <div class="mb-4">
                <h3 class="text-2xl font-heading font-bold text-text-primary mb-2">{bundle.name}</h3>
                <p class="text-text-secondary text-sm">{bundle.description}</p>
              </div>
              <div class="mb-4">
                <span class="text-5xl font-bold text-accent-gold">{bundle.discount_percentage}%</span>
                <span class="block text-text-muted text-sm mt-2">OFF</span>
              </div>
              <div class="text-text-secondary">
                <span class="text-3xl font-bold text-text-primary">{bundle.song_count}</span>
                <span class="ml-2">Songs</span>
              </div>
            </Card>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  <section class="py-16 md:py-24">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl md:text-4xl font-heading font-bold text-text-primary mb-4">
        Ready to Get Started?
      </h2>
      <p class="text-lg text-text-secondary mb-8">
        Choose your song tier and customize with add-ons during checkout.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/order/wedding"
          class="inline-flex items-center justify-center px-8 py-4 bg-accent-gold text-primary-black text-lg font-medium rounded-lg hover:bg-accent-goldHover transition-colors"
        >
          Order Now
        </a>
        <a
          href="/contact"
          class="inline-flex items-center justify-center px-8 py-4 border-2 border-text-muted text-text-primary text-lg font-medium rounded-lg hover:border-accent-gold hover:text-accent-gold transition-colors"
        >
          Contact Us
        </a>
      </div>
    </div>
  </section>
</PublicLayout>

<script>
  // Currency toggle functionality
  const currencyBtns = document.querySelectorAll('.currency-btn');
  const priceDisplays = document.querySelectorAll('.price-display');

  currencyBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const currency = btn.getAttribute('data-currency');

      // Update active state
      currencyBtns.forEach((b) => b.classList.remove('active', 'bg-accent-gold', 'text-primary-black'));
      btn.classList.add('active', 'bg-accent-gold', 'text-primary-black');

      // Update prices
      priceDisplays.forEach((display) => {
        const priceValue = display.querySelector('.price-value');
        const priceCurrency = display.querySelector('.price-currency');
        const percentage = display.getAttribute('data-percentage');

        // Skip percentage-based pricing
        if (percentage) return;

        if (currency === 'USD') {
          const usd = display.getAttribute('data-usd');
          if (priceValue) priceValue.textContent = `$${usd}`;
          if (priceCurrency) priceCurrency.textContent = 'USD';
        } else {
          const xaf = parseInt(display.getAttribute('data-xaf') || '0');
          if (priceValue) priceValue.textContent = xaf.toLocaleString();
          if (priceCurrency) priceCurrency.textContent = 'CFA';
        }
      });
    });
  });

  // Initialize first button as active
  const firstBtn = document.querySelector('.currency-btn.active');
  if (firstBtn) {
    firstBtn.classList.add('bg-accent-gold', 'text-primary-black');
  }
</script>

<style>
  .currency-btn {
    color: var(--color-text-secondary);
  }
  .currency-btn:hover:not(.active) {
    color: var(--color-text-primary);
  }
  .currency-btn.active {
    background-color: var(--color-accent-gold);
    color: var(--color-primary-black);
  }
</style>
