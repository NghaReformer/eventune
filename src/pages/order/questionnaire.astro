---
/**
 * Questionnaire Page
 * Collect story details for custom song creation
 * Uses dynamic fields from database with fallback to hardcoded fields
 */

import PublicLayout from '@/layouts/PublicLayout.astro';
import Card from '@/components/ui/Card.astro';
import Input from '@/components/ui/Input.astro';
import Textarea from '@/components/ui/Textarea.astro';
import Button from '@/components/ui/Button.astro';
import Badge from '@/components/ui/Badge.astro';
import { getQuestionnaireFields, type QuestionnaireField } from '@/services/questionnaire.service';
import { getOccasionBySlug } from '@/services/config.service';

// Get query parameters
const url = new URL(Astro.request.url);
const packageSlug = url.searchParams.get('package') || 'classic';
const occasionSlug = url.searchParams.get('occasion') || 'wedding';

// Fetch occasion info and dynamic questionnaire fields
let occasionName = occasionSlug.charAt(0).toUpperCase() + occasionSlug.slice(1);
let fields: QuestionnaireField[] = [];

try {
  const [occasion, dynamicFields] = await Promise.all([
    getOccasionBySlug(occasionSlug),
    getQuestionnaireFields(occasionSlug),
  ]);

  if (occasion) {
    occasionName = occasion.name;
  }

  fields = dynamicFields;
} catch (error) {
  console.error('[Questionnaire] Error fetching fields:', error);
}

// Fallback to hardcoded fields if database fields are empty
const useFallback = fields.length === 0;

// Debug logging
console.log('[Questionnaire] Fields fetched:', fields.length);
console.log('[Questionnaire] Using fallback:', useFallback);
if (fields.length > 0) {
  const genreField = fields.find(f => f.field_name === 'genre');
  console.log('[Questionnaire] Genre field:', JSON.stringify(genreField, null, 2));
}

// Hardcoded fallback fields (used when database not ready)
const fallbackFields: QuestionnaireField[] = [
  // Recipient group
  {
    id: 'fallback-1',
    occasion_slug: null,
    field_name: 'recipient_name',
    field_type: 'text',
    field_label: 'Who is this song for?',
    placeholder: 'e.g., Sarah, Mom, John & Mary',
    help_text: 'The person or people this song celebrates',
    required: true,
    display_order: 1,
    options: null,
    field_group: 'recipient',
    validation_rules: null,
    is_active: true,
    created_at: '',
    updated_at: '',
  },
  {
    id: 'fallback-2',
    occasion_slug: null,
    field_name: 'recipient_relationship',
    field_type: 'select',
    field_label: 'Your relationship to them',
    placeholder: 'Select relationship',
    help_text: null,
    required: true,
    display_order: 2,
    options: [
      { value: 'spouse', label: 'Spouse / Partner' },
      { value: 'parent', label: 'Parent' },
      { value: 'child', label: 'Child' },
      { value: 'sibling', label: 'Sibling' },
      { value: 'friend', label: 'Friend' },
      { value: 'grandparent', label: 'Grandparent' },
      { value: 'other_family', label: 'Other Family Member' },
      { value: 'colleague', label: 'Colleague' },
      { value: 'other', label: 'Other' },
    ],
    field_group: 'recipient',
    validation_rules: null,
    is_active: true,
    created_at: '',
    updated_at: '',
  },
  {
    id: 'fallback-3',
    occasion_slug: null,
    field_name: 'occasion_date',
    field_type: 'date',
    field_label: 'When is the occasion?',
    placeholder: null,
    help_text: 'This helps us prioritize delivery',
    required: false,
    display_order: 3,
    options: null,
    field_group: 'recipient',
    validation_rules: null,
    is_active: true,
    created_at: '',
    updated_at: '',
  },
  // Memories group
  {
    id: 'fallback-4',
    occasion_slug: null,
    field_name: 'story',
    field_type: 'textarea',
    field_label: 'Tell us about your story',
    placeholder: 'Share the memories, moments, and feelings you want captured in the song. Include specific details, inside jokes, meaningful places, or special phrases that matter to you both...',
    help_text: 'This is the heart of your song. The more detail, the better!',
    required: true,
    display_order: 1,
    options: null,
    field_group: 'memories',
    validation_rules: { max_length: 3000 },
    is_active: true,
    created_at: '',
    updated_at: '',
  },
  // Song preferences group
  {
    id: 'fallback-5',
    occasion_slug: null,
    field_name: 'genre',
    field_type: 'select',
    field_label: 'Preferred genre/style',
    placeholder: 'Let our artists decide',
    help_text: null,
    required: false,
    display_order: 1,
    options: [
      { value: 'pop', label: 'Pop' },
      { value: 'rnb', label: 'R&B / Soul' },
      { value: 'acoustic', label: 'Acoustic' },
      { value: 'country', label: 'Country' },
      { value: 'gospel', label: 'Gospel' },
      { value: 'jazz', label: 'Jazz' },
      { value: 'afrobeats', label: 'Afrobeats' },
      { value: 'classical', label: 'Classical' },
    ],
    field_group: 'song_preferences',
    validation_rules: null,
    is_active: true,
    created_at: '',
    updated_at: '',
  },
  {
    id: 'fallback-6',
    occasion_slug: null,
    field_name: 'moods',
    field_type: 'checkbox',
    field_label: 'Mood/Feeling',
    placeholder: null,
    help_text: 'Select all that apply',
    required: false,
    display_order: 2,
    options: [
      { value: 'romantic', label: 'Romantic' },
      { value: 'upbeat', label: 'Upbeat' },
      { value: 'emotional', label: 'Emotional' },
      { value: 'celebratory', label: 'Celebratory' },
      { value: 'nostalgic', label: 'Nostalgic' },
      { value: 'inspirational', label: 'Inspirational' },
    ],
    field_group: 'song_preferences',
    validation_rules: null,
    is_active: true,
    created_at: '',
    updated_at: '',
  },
  {
    id: 'fallback-7',
    occasion_slug: null,
    field_name: 'special_requests',
    field_type: 'textarea',
    field_label: 'Any specific requests?',
    placeholder: 'Reference songs you like, specific lyrics to include, or anything else we should know...',
    help_text: null,
    required: false,
    display_order: 3,
    options: null,
    field_group: 'song_preferences',
    validation_rules: { max_length: 1000 },
    is_active: true,
    created_at: '',
    updated_at: '',
  },
];

// Use dynamic fields or fallback
const activeFields = useFallback ? fallbackFields : fields;

// Group fields by field_group
const groupedFields: Record<string, QuestionnaireField[]> = {};
const groupOrder = ['recipient', 'relationship', 'memories', 'song_preferences', 'additional'];
const groupLabels: Record<string, string> = {
  recipient: 'About the Recipient',
  relationship: 'Your Relationship',
  memories: 'Your Story',
  song_preferences: 'Music Preferences',
  additional: 'Additional Information',
};

// Initialize groups
groupOrder.forEach(group => {
  groupedFields[group] = [];
});

// Populate groups
activeFields.forEach(field => {
  const group = field.field_group || 'additional';
  if (!groupedFields[group]) {
    groupedFields[group] = [];
  }
  groupedFields[group].push(field);
});

// Filter out empty groups
const nonEmptyGroups = groupOrder.filter(group => groupedFields[group].length > 0);

// Story tips for the memories section
const storyTips = [
  'How did you meet or when did your relationship begin?',
  'What are your favorite memories together?',
  'What makes this person special to you?',
  'Any nicknames, inside jokes, or special phrases?',
  'What do you want them to feel when they hear this song?',
];
---

<PublicLayout
  title="Tell Your Story | Eventune Studios"
  description="Share the details of your story so we can create the perfect personalized song."
>
  <!-- Steps Indicator -->
  <section class="py-8 bg-primary-cardBlack border-b border-text-muted/20">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-center gap-2 md:gap-4">
        {[
          { step: 1, label: 'Choose Package', active: false, completed: true },
          { step: 2, label: 'Tell Your Story', active: true, completed: false },
          { step: 3, label: 'Checkout', active: false, completed: false },
        ].map(({ step, label, active, completed }) => (
          <div class="flex items-center">
            <div class={`flex items-center gap-2 ${active ? 'text-accent-gold' : completed ? 'text-status-success' : 'text-text-muted'}`}>
              <div class={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                active ? 'bg-accent-gold text-primary-black' :
                completed ? 'bg-status-success text-primary-black' : 'bg-text-muted/20'
              }`}>
                {completed ? (
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                ) : step}
              </div>
              <span class="hidden sm:inline text-sm font-medium">{label}</span>
            </div>
            {step < 3 && (
              <div class={`w-8 md:w-16 h-0.5 mx-2 ${completed ? 'bg-status-success' : 'bg-text-muted/20'}`}></div>
            )}
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Questionnaire Form -->
  <section class="py-12 md:py-16">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-heading font-bold text-text-primary mb-2">
          Tell Us Your Story
        </h1>
        <p class="text-text-secondary">
          The more details you share, the more personal and meaningful your song will be.
        </p>
      </div>

      <!-- Order Summary -->
      <Card variant="bordered" class="border-accent-gold/30 mb-8">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-text-muted text-sm">Selected Package</p>
            <p class="text-text-primary font-medium" id="package-name">Loading...</p>
          </div>
          <div class="text-right">
            <p class="text-text-muted text-sm">Occasion</p>
            <p class="text-text-primary font-medium capitalize" id="occasion-name">{occasionName}</p>
          </div>
          <a
            href={`/order/${occasionSlug}?package=${packageSlug}`}
            class="text-sm text-accent-gold hover:text-accent-goldHover transition-colors"
          >
            Change
          </a>
        </div>
      </Card>

      <form id="questionnaire-form" class="space-y-8">
        <!-- Hidden fields -->
        <input type="hidden" name="package_slug" value={packageSlug} />
        <input type="hidden" name="occasion_slug" value={occasionSlug} />

        <!-- Dynamic Field Groups -->
        {nonEmptyGroups.map((group, groupIndex) => (
          <Card variant="elevated">
            <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 flex items-center gap-2">
              <span class="w-8 h-8 rounded-full bg-accent-gold/20 flex items-center justify-center text-accent-gold text-sm font-bold">
                {groupIndex + 1}
              </span>
              {groupLabels[group]}
            </h2>

            <div class="space-y-4">
              {groupedFields[group].map((field) => (
                <div class="field-container" data-field-name={field.field_name}>
                  {/* Text Input */}
                  {field.field_type === 'text' && (
                    <Input
                      label={field.field_label}
                      name={field.field_name}
                      placeholder={field.placeholder || ''}
                      required={field.required}
                      hint={field.help_text || undefined}
                      maxlength={field.validation_rules?.max_length}
                    />
                  )}

                  {/* Email Input */}
                  {field.field_type === 'email' && (
                    <Input
                      label={field.field_label}
                      name={field.field_name}
                      type="email"
                      placeholder={field.placeholder || ''}
                      required={field.required}
                      hint={field.help_text || undefined}
                    />
                  )}

                  {/* Phone Input */}
                  {field.field_type === 'phone' && (
                    <Input
                      label={field.field_label}
                      name={field.field_name}
                      type="tel"
                      placeholder={field.placeholder || ''}
                      required={field.required}
                      hint={field.help_text || undefined}
                    />
                  )}

                  {/* Number Input */}
                  {field.field_type === 'number' && (
                    <Input
                      label={field.field_label}
                      name={field.field_name}
                      type="number"
                      placeholder={field.placeholder || ''}
                      required={field.required}
                      hint={field.help_text || undefined}
                      min={field.validation_rules?.min}
                      max={field.validation_rules?.max}
                    />
                  )}

                  {/* Date Input */}
                  {field.field_type === 'date' && (
                    <Input
                      label={field.field_label}
                      name={field.field_name}
                      type="date"
                      required={field.required}
                      hint={field.help_text || undefined}
                    />
                  )}

                  {/* Textarea */}
                  {field.field_type === 'textarea' && (
                    <>
                      <Textarea
                        label={field.field_label}
                        name={field.field_name}
                        placeholder={field.placeholder || ''}
                        rows={8}
                        required={field.required}
                        maxLength={field.validation_rules?.max_length || 3000}
                        hint={field.help_text || undefined}
                      />
                      {/* Show story tips for story field */}
                      {field.field_name === 'story' && (
                        <div class="bg-primary-hoverBlack rounded-lg p-4 text-sm mt-4">
                          <p class="text-text-primary font-medium mb-2">Tips for a great story:</p>
                          <ul class="text-text-secondary space-y-1">
                            {storyTips.map((tip) => (
                              <li>â€¢ {tip}</li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </>
                  )}

                  {/* Select Dropdown */}
                  {field.field_type === 'select' && (
                    <div>
                      <label class="block text-sm font-medium text-text-primary mb-2">
                        {field.field_label} {field.required && <span class="text-status-error">*</span>}
                      </label>
                      <select
                        name={field.field_name}
                        required={field.required}
                        class="w-full px-4 py-3 bg-primary-cardBlack border border-text-muted/30 rounded-lg text-text-primary focus:outline-none focus:ring-2 focus:ring-accent-gold/50 focus:border-accent-gold"
                      >
                        <option value="">{field.placeholder || 'Select an option'}</option>
                        {Array.isArray(field.options) && field.options.length > 0 && field.options.map((opt) => (
                          <option value={opt.value}>{opt.label}</option>
                        ))}
                      </select>
                      {field.help_text && (
                        <p class="text-text-muted text-sm mt-1">{field.help_text}</p>
                      )}
                    </div>
                  )}

                  {/* Radio Buttons */}
                  {field.field_type === 'radio' && (
                    <div>
                      <label class="block text-sm font-medium text-text-primary mb-2">
                        {field.field_label} {field.required && <span class="text-status-error">*</span>}
                      </label>
                      <div class="space-y-2">
                        {field.options?.map((opt) => (
                          <label class="flex items-center gap-3 p-3 bg-primary-hoverBlack rounded-lg cursor-pointer hover:bg-primary-cardBlack transition-colors">
                            <input
                              type="radio"
                              name={field.field_name}
                              value={opt.value}
                              required={field.required}
                              class="w-4 h-4 text-accent-gold bg-primary-cardBlack border-text-muted/30 focus:ring-accent-gold"
                            />
                            <span class="text-text-secondary">{opt.label}</span>
                          </label>
                        ))}
                      </div>
                      {field.help_text && (
                        <p class="text-text-muted text-sm mt-2">{field.help_text}</p>
                      )}
                    </div>
                  )}

                  {/* Checkbox Group */}
                  {field.field_type === 'checkbox' && (
                    <div>
                      <label class="block text-sm font-medium text-text-primary mb-2">
                        {field.field_label}
                      </label>
                      <div class="flex flex-wrap gap-2">
                        {field.options?.map((opt) => (
                          <label class="mood-tag">
                            <input type="checkbox" name={field.field_name} value={opt.value} class="sr-only" />
                            <span class="px-4 py-2 rounded-full border border-text-muted/30 text-text-secondary text-sm cursor-pointer hover:border-accent-gold hover:text-accent-gold transition-colors">
                              {opt.label}
                            </span>
                          </label>
                        ))}
                      </div>
                      {field.help_text && (
                        <p class="text-text-muted text-sm mt-2">{field.help_text}</p>
                      )}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </Card>
        ))}

        <!-- Currency Selection -->
        <Card variant="elevated">
          <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 flex items-center gap-2">
            <span class="w-8 h-8 rounded-full bg-accent-gold/20 flex items-center justify-center text-accent-gold text-sm font-bold">
              {nonEmptyGroups.length + 1}
            </span>
            Payment Currency
          </h2>

          <div class="grid grid-cols-2 gap-4">
            <label class="currency-option">
              <input type="radio" name="currency" value="USD" checked class="sr-only" />
              <div class="p-4 rounded-lg border-2 border-accent-gold bg-accent-gold/10 text-center cursor-pointer transition-all">
                <span class="text-2xl font-bold text-accent-gold">USD</span>
                <p class="text-text-secondary text-sm mt-1">US Dollar</p>
                <p class="text-text-muted text-xs">Credit/Debit Card</p>
              </div>
            </label>
            <label class="currency-option">
              <input type="radio" name="currency" value="XAF" class="sr-only" />
              <div class="p-4 rounded-lg border-2 border-text-muted/30 text-center cursor-pointer transition-all hover:border-accent-gold/50">
                <span class="text-2xl font-bold text-text-primary">XAF</span>
                <p class="text-text-secondary text-sm mt-1">CFA Franc</p>
                <p class="text-text-muted text-xs">Mobile Money</p>
              </div>
            </label>
          </div>
        </Card>

        <!-- Error Message -->
        <div id="error-message" class="hidden p-4 bg-status-error/20 border border-status-error rounded-lg text-status-error">
        </div>

        <!-- Submit -->
        <div class="flex flex-col sm:flex-row gap-4">
          <a
            href={`/order/${occasionSlug}?package=${packageSlug}`}
            class="flex-1 inline-flex items-center justify-center px-6 py-4 border border-text-muted text-text-primary rounded-lg hover:border-accent-gold hover:text-accent-gold transition-colors"
          >
            &larr; Back
          </a>
          <Button type="submit" variant="primary" size="lg" class="flex-1" id="submit-btn">
            Continue to Checkout
          </Button>
        </div>
      </form>
    </div>
  </section>
</PublicLayout>

<script>
  import { supabase } from '@/lib/supabase/client';

  const form = document.getElementById('questionnaire-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorMessage = document.getElementById('error-message') as HTMLElement;
  const packageName = document.getElementById('package-name') as HTMLElement;

  // Get URL params
  const urlParams = new URLSearchParams(window.location.search);
  const packageSlug = urlParams.get('package') || 'classic';
  const occasionSlug = urlParams.get('occasion') || 'wedding';

  // Package display names
  const packageNames: Record<string, string> = {
    express: 'Express',
    classic: 'Classic',
    signature: 'Signature',
    legacy: 'Legacy',
  };

  if (packageName) {
    packageName.textContent = packageNames[packageSlug] || packageSlug;
  }

  // Currency selection
  const currencyOptions = document.querySelectorAll('.currency-option');
  currencyOptions.forEach((option) => {
    const input = option.querySelector('input') as HTMLInputElement;
    const div = option.querySelector('div') as HTMLElement;

    input?.addEventListener('change', () => {
      currencyOptions.forEach((opt) => {
        const d = opt.querySelector('div');
        d?.classList.remove('border-accent-gold', 'bg-accent-gold/10');
        d?.classList.add('border-text-muted/30');
      });

      if (input.checked) {
        div?.classList.remove('border-text-muted/30');
        div?.classList.add('border-accent-gold', 'bg-accent-gold/10');
      }
    });
  });

  // Checkbox/Mood tags interaction
  const moodTags = document.querySelectorAll('.mood-tag');
  moodTags.forEach((tag) => {
    const input = tag.querySelector('input') as HTMLInputElement;
    const span = tag.querySelector('span') as HTMLElement;

    tag.addEventListener('click', () => {
      input.checked = !input.checked;
      if (input.checked) {
        span?.classList.remove('border-text-muted/30', 'text-text-secondary');
        span?.classList.add('border-accent-gold', 'bg-accent-gold/10', 'text-accent-gold');
      } else {
        span?.classList.add('border-text-muted/30', 'text-text-secondary');
        span?.classList.remove('border-accent-gold', 'bg-accent-gold/10', 'text-accent-gold');
      }
    });
  });

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage?.classList.remove('hidden');
    errorMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function hideError() {
    errorMessage?.classList.add('hidden');
  }

  // Check auth on load
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (!session) {
      // Save current URL and redirect to login
      const returnUrl = window.location.pathname + window.location.search;
      window.location.href = `/auth/login?redirectTo=${encodeURIComponent(returnUrl)}`;
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const formData = new FormData(form);

    // Collect all form data dynamically
    const questionnaire: Record<string, unknown> = {};

    // Process form data
    for (const [key, value] of formData.entries()) {
      if (key === 'package_slug' || key === 'occasion_slug' || key === 'currency') {
        continue; // Skip meta fields
      }

      // Handle checkbox fields (collect as array)
      const existingValue = questionnaire[key];
      if (existingValue !== undefined) {
        if (Array.isArray(existingValue)) {
          existingValue.push(value as string);
        } else {
          questionnaire[key] = [existingValue, value as string];
        }
      } else {
        questionnaire[key] = value;
      }
    }

    // Clean up empty values
    Object.keys(questionnaire).forEach(key => {
      if (questionnaire[key] === '' || questionnaire[key] === undefined) {
        delete questionnaire[key];
      }
    });

    const data = {
      package_slug: formData.get('package_slug'),
      occasion_slug: formData.get('occasion_slug'),
      currency: formData.get('currency'),
      questionnaire,
    };

    // Validate required fields
    const requiredMissing: string[] = [];
    document.querySelectorAll('[required]').forEach((el) => {
      const name = (el as HTMLInputElement).name;
      if (!questionnaire[name]) {
        requiredMissing.push(name);
      }
    });

    if (requiredMissing.length > 0) {
      showError('Please fill in all required fields.');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    try {
      const response = await fetch('/api/orders/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (!response.ok) {
        showError(result.error || 'Failed to create order. Please try again.');
        return;
      }

      // Redirect to checkout
      window.location.href = `/order/checkout?order_id=${result.order_id}&currency=${data.currency}`;

    } catch (error) {
      console.error('Order creation error:', error);
      showError('An unexpected error occurred. Please try again.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Continue to Checkout';
    }
  });
</script>

<style>
  .mood-tag input:checked + span {
    border-color: var(--color-accent-gold);
    background-color: rgba(var(--color-accent-gold-rgb), 0.1);
    color: var(--color-accent-gold);
  }
</style>
